name: Sync Config to QL Branch

on:
  # å½“masteråˆ†æ”¯çš„config_example.ymlå‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨æ‰§è¡Œ
  push:
    branches: [ master ]
    paths:
      - 'config_example.yml'
  
  # æ‰‹åŠ¨æ‰§è¡Œ
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆå³ä½¿æ–‡ä»¶æ— å˜åŒ–ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  sync-config:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Check if ql branch exists
      id: check_branch
      run: |
        if git show-ref --verify --quiet refs/remotes/origin/ql; then
          echo "branch_exists=true" >> $GITHUB_OUTPUT
          echo "qlåˆ†æ”¯å­˜åœ¨"
        else
          echo "branch_exists=false" >> $GITHUB_OUTPUT
          echo "qlåˆ†æ”¯ä¸å­˜åœ¨"
        fi
    
    - name: Sync config to ql branch
      if: steps.check_branch.outputs.branch_exists == 'true'
      run: |
        echo "å¼€å§‹åŒæ­¥é…ç½®æ–‡ä»¶åˆ°qlåˆ†æ”¯"
        
        # åˆ‡æ¢åˆ°qlåˆ†æ”¯
        git checkout ql
        git pull origin ql
        
        # ä»Žmasteråˆ†æ”¯èŽ·å–æœ€æ–°çš„config_example.yml
        git checkout master -- config_example.yml
        
        # ç¡®ä¿qinglongç›®å½•å­˜åœ¨
        mkdir -p qinglong
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp config_example.yml qinglong/config_example.yml
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        git add qinglong/config_example.yml
        
        if git diff --staged --quiet && [ "${{ github.event.inputs.force_sync }}" != "true" ]; then
          echo "é…ç½®æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          # æäº¤å˜åŒ–
          if [ "${{ github.event.inputs.force_sync }}" == "true" ]; then
            commit_msg="sync: å¼ºåˆ¶åŒæ­¥masteråˆ†æ”¯çš„config_example.ymlåˆ°qlåˆ†æ”¯"
          else
            commit_msg="sync: åŒæ­¥masteråˆ†æ”¯çš„config_example.ymlåˆ°qlåˆ†æ”¯

è‡ªåŠ¨åŒæ­¥è§¦å‘äºŽ: ${{ github.sha }}
å˜æ›´æ–‡ä»¶: config_example.yml"
          fi
          
          git commit -m "$commit_msg"
          git push origin ql
          
          echo "âœ… é…ç½®æ–‡ä»¶åŒæ­¥å®Œæˆ"
          echo "ðŸ“ æäº¤ä¿¡æ¯: $commit_msg"
        fi
    
    - name: Create ql branch if not exists
      if: steps.check_branch.outputs.branch_exists == 'false'
      run: |
        echo "qlåˆ†æ”¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°åˆ†æ”¯"
        
        # åˆ›å»ºqlåˆ†æ”¯
        git checkout -b ql
        
        # åˆ›å»ºqinglongç›®å½•å’Œæ–‡ä»¶
        mkdir -p qinglong
        cp config_example.yml qinglong/config_example.yml
        
        # åˆ›å»ºåŸºæœ¬çš„é’é¾™é¢æ¿æ–‡ä»¶
        cat > qinglong/ck_ptsites.py << 'EOF'
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
cron: 30 8 * * *
new Env('PTç«™ç‚¹è‡ªåŠ¨ç­¾åˆ°');
"""

# PTç«™ç‚¹è‡ªåŠ¨ç­¾åˆ°è„šæœ¬ - é’é¾™é¢æ¿ç‰ˆæœ¬
# è¯·ç¡®ä¿å·²å®‰è£… pt-checkin åŒ…: pip install pt-checkin

import subprocess
import sys

def main():
    """ä¸»å‡½æ•°"""
    print("ðŸš€ === PTç«™ç‚¹è‡ªåŠ¨ç­¾åˆ°å¼€å§‹ ===")
    
    try:
        # æ‰§è¡Œpt-checkinå‘½ä»¤
        result = subprocess.run([
            sys.executable, '-m', 'pt_checkin.cli', 'run'
        ], capture_output=True, text=True, cwd='/ql/scripts')
        
        print("ðŸ“Š ç­¾åˆ°æ‰§è¡Œç»“æžœ:")
        print(result.stdout)
        
        if result.stderr:
            print("âš ï¸ é”™è¯¯ä¿¡æ¯:")
            print(result.stderr)
        
        if result.returncode == 0:
            print("ðŸŽ‰ ç­¾åˆ°ä»»åŠ¡å®Œæˆ")
        else:
            print(f"âŒ ç­¾åˆ°ä»»åŠ¡å¤±è´¥ï¼Œé€€å‡ºç : {result.returncode}")
            
    except Exception as e:
        print(f"âŒ æ‰§è¡Œå¼‚å¸¸: {e}")

if __name__ == '__main__':
    main()
EOF
        
        cat > qinglong/notify.py << 'EOF'
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
é’é¾™é¢æ¿é€šçŸ¥æ¨¡å—
"""

def send(title: str, content: str):
    """
    å‘é€é€šçŸ¥
    
    Args:
        title: é€šçŸ¥æ ‡é¢˜
        content: é€šçŸ¥å†…å®¹
    """
    print(f"[é€šçŸ¥] {title}")
    print(f"å†…å®¹: {content}")
    print("-" * 50)
EOF
        
        # æäº¤æ–°åˆ†æ”¯
        git add .
        git commit -m "feat: åˆ›å»ºqlåˆ†æ”¯å¹¶æ·»åŠ é’é¾™é¢æ¿æ”¯æŒæ–‡ä»¶

- æ·»åŠ ck_ptsites.pyé’é¾™é¢æ¿ç­¾åˆ°è„šæœ¬
- æ·»åŠ notify.pyé€šçŸ¥æ¨¡å—
- åŒæ­¥config_example.ymlé…ç½®æ–‡ä»¶"
        
        git push origin ql
        
        echo "âœ… qlåˆ†æ”¯åˆ›å»ºå®Œæˆ"
